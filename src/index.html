<html>
  <head>
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js"></script>
    <script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="graph">
      <ul>

      </ul>
    </div>
    <div id="layers">
      <a id="eventArticles">Event articles</a>
      <a id="subsequentArticles">Subsequent articles</a>
      <a id="eventSources">Event sources</a>
      <a id="subsequentSources">Subsequent sources</a>
    </div>
    <div id="filters">
      <div id="deathClassification">
      </div>
      <div id="state">
      </div>
      <div id="armed">
      </div>
      <div id="source">
      </div>
      <div id="race">
      </div>
      <div id="gender">
      </div>
    </div>
    <div id="legend">
    </div>
    <div id="eventList">
      <input id="eventFilter" type="text" />
      <button id="selectAll">Select All</button>
      <button id="selectNone">Select None</button>
      <ul>
      </ul>
    </div>
  </body>
  <script type="text/javascript">

    var deaths = [];
    var months = ["January", "February", "March", "April", "May", "June",
                  "July", "August", "September", "October", "November", "December"];

    $("#eventFilter").on("input", function() {
      refreshEventList();
    });
    $("#selectAll").on("click", function() {
      for(var i = 0; i < deaths.length; i++) {
        deaths[i].selected = true;
      }
      refreshEventList();
      refreshChart();
    });
    $("#selectNone").on("click", function() {
      for(var i = 0; i < deaths.length; i++) {
        deaths[i].selected = false;
      }
      refreshEventList();
      refreshChart();
    });


    // Load the dataset
    d3.csv('data/all-events.csv', function(err, result) {
      if(err) {
        console.error('Error loading data:', err);
      }
      deaths = result;

      refreshData();
    });
    //
    function refreshData() {
      refreshEventList();
      refreshChart();
    }

    function refreshEventList() {
        var eventList = d3.select('#eventList ul');
        var filter = $("#eventFilter").val();

        var filteredDeaths = deaths.filter(function(death) { return death.name.toLowerCase().indexOf((filter || '').toLowerCase()) > -1; });

        var changes = eventList.selectAll('li').data(filteredDeaths, function(death) { return death.uid; });

        changes.enter()
          .append('li');
        changes.exit()
          .remove();
        changes
          .text(function(death) { return death.name; })
          .attr('class', function(death) { return death.selected ? 'selected' : ''; })
          .on("click", function(death) {
            death.selected = !death.selected;
            refreshEventList();
            refreshChart();
          });
        changes.sort(function(a,b) { return d3.ascending(a.name, b.name); });
    }
    function refreshChart() {
      var selectedDeaths = deaths.filter(function(d) { return d.selected; });
      var deathsByMonth = d3.nest()
        .key(function(d) { return d.month; })
        .sortKeys(function(a,b) { return d3.ascending(months.indexOf(a), months.indexOf(b)); })
        .entries(selectedDeaths);

        var chart = d3.select("#graph ul");
        var changes = chart.selectAll('li').data(deathsByMonth, function(group) { if(group) return group.key; else return "ungrouped"; });
        changes.enter()
          .append('li');
        changes.exit()
          .remove();
        changes
          .text(function(m) { console.log(m); return m.key + ': ' + m.values.length + ' events'; });
        changes.order();
    }

  </script>
</html>
