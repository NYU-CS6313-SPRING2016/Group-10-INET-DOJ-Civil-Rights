<!DOCTYPE html>
<html>
  <head>
    <script src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" type="text/css" />
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js"></script>
  </head>
  <body>
    <div class="container-fluid">
      <h1> CS6313 Final Project - Racial Tension in Media </h1>
      <div class="row dropdown-labels">
        <div class="col-md-2"><h2>Groups</h2></div>
        <div class="col-md-2"><h2>Color</h2></div>
        <div class="col-md-2"><h2>Size</h2></div>
        <div class="col-md-2"><h2>Order</h2></div>
      </div>
      <div class="row dropdowns">
        <div class="col-md-2">
          <select id="groupingSelection">
            <option value="place">Place</option>
            <option value="race">Race</option>
            <option value="manner">Manner of Death</option>
            <option value="month">Month of Death</option>
          </select>
        </div>
        <div class="col-md-2">
          <select id="colorSelection">
            <option value="race">Race</option>
            <option value="manner">Manner of Death</option>
            <option value="tone">Tone of Articles</option>
          </select>
        </div>
        <div class="col-md-2">
          <select id="sizeSelection">
            <option value="volume">Volume of Articles</option>
            <option value="tone">Tone of Articles</option>
          </select>
        </div>
        <div class="col-md-2">
          <select id="orderingSelection">
            <option value="monthIndex">Month of Death</option>
            <option value="volume">Volume of Articles</option>
            <option value="tone">Tone of Articles</option>
          </select>
        </div>
      </div>
      <div class="row main">
        <div class="col-md-9 grid">
        </div>
        <div class="col-md-3 details">
        </div>
      </div>
      <div class="row legend-footer">
          <h2>Legend<h2>
        <div class="row legend-size">
          <div class="col-md-1"><h3>Size</h3></div>
          <div class="col-md-11 legend"></div>
        </div>
        <div class="row legend-color">
          <div class="col-md-1"><h3>Color</h3></div>
          <div class="col-md-11 legend"></div>
        </div>
      </div>
    </div>
  </body>
  <script type="text/javascript">

    d3.identity = function(x) { return x; }
    var months = ["january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december"];
    var stateNames = {
      "AL": "Alabama",
      "AK": "Alaska",
      "AS": "American Samoa",
      "AZ": "Arizona",
      "AR": "Arkansas",
      "CA": "California",
      "CO": "Colorado",
      "CT": "Connecticut",
      "DE": "Delaware",
      "DC": "District Of Columbia",
      "FM": "Federated States Of Micronesia",
      "FL": "Florida",
      "GA": "Georgia",
      "GU": "Guam",
      "HI": "Hawaii",
      "ID": "Idaho",
      "IL": "Illinois",
      "IN": "Indiana",
      "IA": "Iowa",
      "KS": "Kansas",
      "KY": "Kentucky",
      "LA": "Louisiana",
      "ME": "Maine",
      "MH": "Marshall Islands",
      "MD": "Maryland",
      "MA": "Massachusetts",
      "MI": "Michigan",
      "MN": "Minnesota",
      "MS": "Mississippi",
      "MO": "Missouri",
      "MT": "Montana",
      "NE": "Nebraska",
      "NV": "Nevada",
      "NH": "New Hampshire",
      "NJ": "New Jersey",
      "NM": "New Mexico",
      "NY": "New York",
      "NC": "North Carolina",
      "ND": "North Dakota",
      "MP": "Northern Mariana Islands",
      "OH": "Ohio",
      "OK": "Oklahoma",
      "OR": "Oregon",
      "PW": "Palau",
      "PA": "Pennsylvania",
      "PR": "Puerto Rico",
      "RI": "Rhode Island",
      "SC": "South Carolina",
      "SD": "South Dakota",
      "TN": "Tennessee",
      "TX": "Texas",
      "UT": "Utah",
      "VT": "Vermont",
      "VI": "Virgin Islands",
      "VA": "Virginia",
      "WA": "Washington",
      "WV": "West Virginia",
      "WI": "Wisconsin",
      "WY": "Wyoming"
    };

    var deaths = [];
    var deathsByGroup = {};
    
    var radiusScale, colorScale;

    // Helper functions
    var keys = {
      place: function(death) { return stateNames[death.state]; },
      race: function(death) { return death.raceethnicity; },
      manner: function(death) { return death.classification; },
      month: function(death) { return death.month; },
      monthIndex: function(death) { return months.indexOf(death.month.toLowerCase()); },
      volume: function(death) { 
        if(!death.volume) 
          death.volume = d3.random.normal(5000, 400)(); 
        return death.volume; /* TODO */ 
      },
      tone: function(death) { 
        if(!death.tone) 
          death.tone = d3.random.normal(.5, .5)(); 
        return death.tone; /* TODO */ 
      }
    }
    var sortDirections = {
      monthIndex: "ascending",
      volume: "descending",
      tone: "ascending"
    }

    var currentGroupingKey = keys.place;
    var currentColorKey = keys.race;
    var currentSizeKey = keys.volume;
    var currentSortingKey = keys.monthIndex;
    var currentSortDirection = "ascending";

    function renderLegend(legend, entries, scale, attr) {
      var entryWidth = 300;
      var legendEntries = 
        legend
          .selectAll('.legend-step')
          .data(entries, d3.identity);
      var legendEntering = legendEntries.enter()
        .append('svg')
        .attr('class', 'legend-step')
        .attr('width', entryWidth)
        .attr('height', 125);
      legendEntering
        .append('circle')
        .attr('cx', entryWidth / 2)
        .attr('cy', 75)
        .attr('fill', 'black')
        .attr('r', 25);
      legendEntering
        .append('text')
        .attr('x', entryWidth / 2)
        .attr('y', 15)
        .attr('dy', '.35em')
        .attr('fill', 'black')
        .attr('text-anchor', 'middle')
        .text(d3.identity);
        
      legendEntries
        .selectAll('circle')
        .attr(attr, function(entry) { return scale(entry); });

      legendEntries.exit().remove();
      legendEntries.order();
      
    }   
    
    // Color legend functions
    function renderQuantitativeColorLegend() {
      // Select 5 elements, linearly distributed over the extents
      var extents = d3.extent(deaths, currentColorKey);
      var tempScale = 
        d3.scale
          .linear()
          .domain([0,5])
          .range(extents);
      var entries = [0, 1, 2, 3, 4, 5].map(function(e) { return d3.round(tempScale(e), 2); });
      renderLegend(d3.select('.legend-color'), entries, colorScale, 'fill');
    }
    function renderQualitativeColorLegend() {
      // Pick out the distinct elements
      var distinctKeys = d3.map(deaths, currentColorKey).keys();
      renderLegend(d3.select('.legend-color'), distinctKeys, colorScale, 'fill');
    }
    var renderCurrentColorLegend = renderQualitativeColorLegend;
    

    $("#groupingSelection").change(function(evt) {
      currentGroupingKey = keys[evt.target.value];
      regenerateGroups();
      render();
    });

    $("#colorSelection").change(function(evt) {
      currentColorKey = keys[evt.target.value];
      recomputeColorScale();
      render();
    });

    $("#sizeSelection").change(function(evt) {
      currentSizeKey = keys[evt.target.value];
      recomputeRadiusScale();
      render();
    });

    $("#orderingSelection").change(function(evt) {
      currentSortingKey = keys[evt.target.value];
      currentSortDirection = sortDirections[evt.target.value];
      resortGroups();
      render();
    });
    
    function recomputeRadiusScale() {
      radiusScale = 
        d3.scale.linear()
          .domain(d3.extent(deaths, currentSizeKey))
          .range([5,45])
          .clamp(true);
    }

    function recomputeColorScale() {
      if(currentColorKey === keys.tone) {
        colorScale = 
          d3.scale.linear()
            .domain(d3.extent(deaths, currentColorKey))
            .range(["red", "blue"]);
        renderCurrentColorLegend = renderQuantitativeColorLegend;
      } else {
        var count = d3.map(deaths, currentColorKey).size();
        if(count <= 10) {
          colorScale = d3.scale.category10();
        } else {
          colorScale = d3.scale.category20();
        }
        renderCurrentColorLegend = renderQualitativeColorLegend;
      }
    }

    // Load the dataset
    d3.csv('data/all-events.csv', function(err, result) {
      if(err) {
        console.error('Error loading data:', err);
      }
      deaths = result;
      
      refreshData();
    });

    function refreshData() {
      recomputeRadiusScale();
      recomputeColorScale();
      regenerateGroups();
      render();
    }
    
    function regenerateGroups() {
      deathsByGroup = 
        d3.nest()
          .key(currentGroupingKey)
          .entries(deaths);
      resortGroups();
    }

    function resortGroups() {
      for(var i = 0; i < deathsByGroup.length; i++) {
        deathsByGroup[i].values.sort(function(a, b) { return d3[currentSortDirection](currentSortingKey(a), currentSortingKey(b)); });
      }
    }

    function render() {
      // Setup groups: append a div for each group
      var groups = 
        d3.select('.grid')
          .selectAll('div.group')
          .data(deathsByGroup, function(group) { return group.key; });
      
      // New groups get an h3 with the group display name
      var groupsEntering = 
        groups.enter()
              .append('div')
              .attr('class', 'row group')
              .append('h3').text(function(group) { return group.key; });
      
      // Remove groups that don't exist anymore
      var groupsExiting =
        groups.exit()
              .remove();

      // Setup death circles: append an SVG > Circle for each death in the group
      var deaths = 
        groups.selectAll('svg.deaths')
              .data(function(group) { return group.values; },
                    function(death) { return death.uid; });

      var deathsEntering = 
        deaths.enter()
              .append('svg')
              .attr('class', 'deaths')
              .attr('width', 100)
              .attr('height', 100)
              .append('circle')
              .attr('cx', 50)
              .attr('cy', 50);

      // Set the radius to our radius key and the color to our color key
      deaths.selectAll('circle')
        .attr('r', function(death) { return radiusScale(currentSizeKey(death)); })
        .attr('fill', function(death) { return colorScale(currentColorKey(death));});
        
      var deathsExiting =
        deaths.exit()
              .remove();

      // Make sure they're in the order we expect              
      deaths.order();
      
      // Set up the size legend: choose the steps we want, and run it backwards through the radius scale
      var round = function(x) { return d3.round(x, 2); }
      var sizeLegendSteps = [5, 15, 25, 35, 45].map(radiusScale.invert).map(round);
      renderLegend(d3.select('.legend-size'), sizeLegendSteps, radiusScale, 'r');
      
      // Set up the color legend
      renderCurrentColorLegend();
    }

  </script>
</html>
